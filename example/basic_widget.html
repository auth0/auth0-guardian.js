<!DOCTYPE html>
<html>
  <head>
    <title>2nd Factor Authentication</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <style type="text/css">
      html, body { padding: 0; margin: 0; }

      .table {
        display: table;
        position: absolute;
        height: 100%;
        width: 100%;
        background-color: red;
      }

      .cell {
        display: table-cell;
        vertical-align: middle;
      }

      .content {
        padding: 25px 0px 25px 0px;
        margin-left: auto;
        margin-right: auto;
        width: 280px; /* login widget width */
      }

    </style>
  </head>

  <body>

    <script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="   crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <!-- TODO: Replace by Auth0 cdn version -->
    <script src="https://rawgit.com/dafortune/ecac93fbe831fc3f1480e4f7698af5ba/raw/3d8fbec67fe01108804fe83deb5d6d1fe8fcd7c9/guardianjs.bundle.js"></script>

    <style>
      .hidden {
        display: none
      }

      .container {
        border: 1px solid #ababab;
        width: 400px;
        margin: auto;
        padding: 20px;
        margin-top: 30px;
      }

      .error {
        color: #FFADB3;
      }

      .info {
        color: #33CC33
      }
    </style>

    <div class="container">
      <div class="error hidden" data-error></div>
      <div class="info hidden" data-recovery-report-container>
        <span data-recovery-report></span>
        <button type="button" data-saved-recovery>Got it!</button>
      </div>

      <div data-loading data-screen>Loading...</div>

      <div class="hidden" data-screen data-enrollment-enroll data-factor="sms">
        <div data-enrollment-toolbar>
          <button type="button" data-show-enrollment="push" class="hidden">Push</button>
          <button type="button" data-show-enrollment="sms" class="hidden">SMS</button>
          <button type="button" data-show-enrollment="otp" class="hidden">OTP</button>
        </div>

        <form data-enroll>
          <p>Please enter your phone</p>
          <input type="tel" data-enroll-field="phoneNumber"/>
          <button type="submit">Enroll</button>
        </form>
      </div>

      <div class="hidden" data-screen data-enrollment-confirm data-factor="sms">
        <div data-enrollment-toolbar>
          <button type="button" data-show-enrollment="push" class="hidden">Push</button>
          <button type="button" data-show-enrollment="sms" class="hidden">SMS</button>
          <button type="button" data-show-enrollment="otp" class="hidden">OTP</button>
        </div>

        <form data-confirm>
          <p>Please enter the verification code we sent by SMS</p>
          <input type="text" data-confirm-field="otpCode"/>
          <button type="submit">Confirm enrollment</button>
        </form>
      </div>

      <div class="hidden" data-screen data-enrollment-enroll data-factor="push">
        <div data-enrollment-toolbar>
          <button type="button" data-show-enrollment="push" class="hidden">Push</button>
          <button type="button" data-show-enrollment="sms" class="hidden">SMS</button>
          <button type="button" data-show-enrollment="otp" class="hidden">OTP</button>
        </div>

        <p>Scan this QR With Guardian app</p>
        <div data-qr></div>
      </div>

      <div class="hidden" data-screen data-enrollment-enroll data-factor="otp" data-enrollment-confirm>
        <div data-enrollment-toolbar>
          <button type="button" data-show-enrollment="push" class="hidden">Push</button>
          <button type="button" data-show-enrollment="sms" class="hidden">SMS</button>
          <button type="button" data-show-enrollment="otp" class="hidden">OTP</button>
        </div>

        <form data-confirm>
          <p>Scan this QR With Google Authenticator</p>
          <div data-qr></div>
          <p>Enter a code to confirm enrollment</p>
          <input type="text" data-confirm-field="otpCode"/>
          <button type="submit">Confirm enrollment</button>
        </form>
      </div>

      <div class="hidden" data-screen data-login-confirm="otp">
        <form data-login-verify>
          <p>Enter a code to login</p>
          <input type="text" data-verify-field="otpCode" />
          <button type="submit">Login</button>
        </form>
        <p>
          <button type="button" data-show-recovery>Recovery</button>
        </p>
      </div>

      <div class="hidden" data-screen data-login-confirm="push">
        <p data-request-loading>Sending push notification...</p>
        <p data-request-done>We have sent a push notification to your phone</p>
        <button type="button" data-login-verify-show="otp">I don't have the device handy</button>
        <button type="button" data-request>Retry</button>
        <p>
          <button type="button" data-show-recovery>Recovery</button>
        </p>
      </div>

      <div class="hidden" data-screen data-login-confirm="sms">
        <p data-request-loading>Sending sms...</p>
        <p data-request-done>
          Enter a the code we sent by SMS.
          <button type="button" data-request>Retry</button>
        </p>
        <form data-login-verify>
          <input type="text" data-verify-field="otpCode"/>
          <button type="submit">Login</button>
        </form>
        <p>
          <button type="button" data-show-recovery>Recovery</button>
        </p>
      </div>

      <div class="hidden" data-screen data-recovery>
        <form data-recovery-verify>
          <p>Enter recovery code to login</p>
          <input type="text" data-recovery-field="recoveryCode" />
          <button type="submit">Login</button>
        </form>
      </div>

      <div class="hidden" data-screen data-messages>
        <p data-type></p>
        <p data-message></p>
      </div>

    </div>

    <script>
      (function() {
        var $root = $('body');

        var screen = (function() {
          var $active;

          function transitionTo(to) {
            $to = $(to);

            $('[data-error]').addClass('hidden');
            $('[data-screen]').addClass('hidden');
            $to.removeClass('hidden');
            $active = $to;

            return $active;
          }

          function getActive() {
            return $active
          }

          return {
            getActive: getActive,
            transitionTo: transitionTo
          };
        })();

        var pendingReports = {};

        screen.transitionTo('[data-loading]');

        $root.off('click.saved-recovery')
          .on('click.saved-recovery', '[data-saved-recovery]', function() {
            guardianjs.plugins.formPostCallback();
          });

        // --------------------- Setup Guardian JS ----------------------------

        var guardianjs = new Auth0GuardianJS({
          serviceDomain: "{{ userData.tenant }}.guardian.auth0.com", // {name}.guardian.auth0.com
          requestToken: "{{ requestToken }}",

          issuer: {
            label: "{{ userData.friendlyUserId }}",
            name: "{{ userData.tenant }}",
          }
        });

        // Setup the formPostCallback plugin so it takes care of sending the
        // login result to callback url (probably auth0) for us
        Auth0GuardianJS.plugins
          .formPostCallback({
            callbackUrl: "{{ postActionURL }}",
            before: function(cb) {
              // Delay login a little bit so you can see congrats message
              setTimeout(cb, 5000);
            }
          })(guardianjs);

        // Let's start listening for timeout in case the user takes too long
        // to login and the transaction expires
        guardianjs.events.on('timeout', function(p) {
          showError('Seems that you\'ve taken too long to login');
        });

        // Let's start listening for errors
        guardianjs.events.on('error', function(err) {
          showError(err);
        });

        // ------------------- START Guardian transaction ---------------------
        guardianjs.start().then(function(tx) {
          guardianjs.events.on('enrollment-complete', function(p) {
            // If enrollment is complete but not the transaction
            // we need to render the login screen to continue the
            // transaction
            if (!p.transactionComplete) {
              renderLogin(tx);
            }

            if (p.recoveryCode) {
              $('[data-recovery-report-container]').removeClass('hidden');
              $('[data-recovery-report]').text('Recovery code: ' + p.recoveryCode);
              pendingReports.recovery = true;
            }
          });

          guardianjs.events.on('auth-complete', function(p) {
            if (Object.keys(pendingReports).length === 0) {
              // Login is complete and it is not enrolled, since we have setup the
              // `formPostCallback` plugin the result is going to be sent to the
              // callback url immediatelly (`formPostCallback` call). In case of
              // an enrollment or recovery, we need the user to save the recovery
              // code, so enrollment is delayed up to that point
              guardianjs.plugins.formPostCallback();
            }

            showSuccess('Login complete');
          });

          guardianjs.events.on('auth-rejected', function(p) {
            // Login has been rejected, the transaction can continue anyway
            showLocalError('Login rejected');
          });

          if (tx.isEnrolled()) {
            // If user is enrolled let's go to login screen
            renderLogin(tx);
          } else {
            // If user is not enrolled let's go to enrollment screen
            renderEnrollment(tx);
          }

          return null;
        })
        .catch(showError);

        function requestFactorAuth(authFactor) {
          var $active = screen.getActive();
          $active.find('[data-request-loading]').removeClass('hidden');
          $active.find('[data-request-done]').addClass('hidden');

          // Authentication has two different parts, request auth and
          // verify auth, the request part is used to request an auth
          // based on the enrolled factor. You will get a push if you have
          // enrolled with push, an sms if you have enrolled with sms, nothing
          // if you have enrolled with otp
          authFactor.request()
            .then(function() {
              var $active = screen.getActive();
              $active.find('[data-request-loading]').addClass('hidden');
              $active.find('[data-request-done]').removeClass('hidden');

              return null;
            })
            .catch(showLocalError);
        }

        function renderLogin(tx, factor) {
          var auth = tx.startAuth();
          factor = factor || auth.getDefaultFactor();
          var authFactor = auth.forFactor(factor);

          screen.transitionTo('[data-login-confirm="' + factor + '"]');

          requestFactorAuth(authFactor);

          $root
            .off('submit.login-verify')
            .on('submit.login-verify', '[data-login-verify]', function(evt) {
              evt.preventDefault();

              var data = getData(screen.getActive(), '[data-verify-field]',
                              'verify-field');

              authFactor.verify(data).catch(showLocalError);
            });

          $root
            .off('submit.recovery-verify')
            .on('submit.recovery-verify', '[data-recovery-verify]', function(evt) {
              evt.preventDefault();

              delete pendingReports.recovery;

              var data = getData(screen.getActive(), '[data-recovery-field]',
                              'recovery-field');

              tx.startAuthForRecovery().verify(data).catch(showLocalError);
            });

        $root
          .off('click.login-verify-show')
          .on('click.login-verify-show', '[data-login-verify-show]', function() {
            renderLogin(tx, 'otp');
          });

          $root
            .off('click.request')
            .on('click.request', '[data-request]', function() {
              requestFactorAuth(authFactor)
            });

          $root
            .off('click.show-recovery')
            .on('click.show-recovery', '[data-show-recovery]', function() {
              screen.transitionTo('[data-recovery]');
            });
        }

        function renderEnrollmentToFactor(enrollmentFlow, factor) {
          // Get a transaction for a given factor
          var enrollmentFactor = enrollmentFlow.forFactor(factor);

          screen.transitionTo('[data-enrollment-enroll]' +
                              '[data-factor="' + factor + '"]');

          // Show the QR if there is an enrollment URI, if the factor
          // doesn't support an URI you will get null on getUri() method
          var $qr = screen.getActive().find('[data-qr]');
          if ($qr.length) {
            $qr.empty().qrcode(enrollmentFactor.getUri());
          }

          $root
            .off('submit.enroll')
            .on('submit.enroll', '[data-enroll]', function(evt) {
              evt.preventDefault();

              var data = getData(screen.getActive(),
                                  '[data-enroll-field]', 'enroll-field');

              // Sends enrollment data to the server. This is the first step of
              // enrollment. You need to send phoneNumber for sms, the other
              // factors doesn't need sending data, but the method is a
              // NOOP that returns a promise just as a convenience
              enrollmentFactor.enroll(data).then(function() {
                screen.transitionTo('[data-enrollment-confirm]' +
                                    '[data-factor="' + factor + '"]');

                return null;
              })
              .catch(showLocalError);
            });

          $root
            .off('submit.confirm')
            .on('submit.confirm', '[data-confirm]', function(evt) {
              evt.preventDefault();

              var data = getData(screen.getActive(),
                                  '[data-confirm-field]', 'confirm-field');

              // Once enroll information is sent you have to confirm the
              // enrollment by sending the first otp code
              enrollmentFactor.confirm(data).catch(showLocalError);
          });
        }

        function renderEnrollment(tx) {
          var enrollmentFlow = tx.startEnrollment();
          var availableFactors = enrollmentFlow.getAvailableFactors();

          var i;
          for (i = 0; i < availableFactors.length; i++) {
            $root.find('[data-show-enrollment="' + availableFactors[i] + '"]')
              .removeClass('hidden');
          }

          screen.transitionTo('[data-enrollment-enroll][data-factor="' + availableFactors[0] + '"]');

          renderEnrollmentToFactor(enrollmentFlow, availableFactors[0]);

          $root
            .off('click.show-enrollment')
            .on('click.show-enrollment', '[data-show-enrollment]', function(evt) {
              factor = $(evt.target).data('show-enrollment');
              renderEnrollmentToFactor(enrollmentFlow, factor);
            });
        }

        // ----------------------------- Utilities ------------------------------

        function showMessage(message, type) {
          $messages = $('[data-messages]');

          screen.transitionTo($messages);

          $messages.attr('class', type);
          $messages.find('[data-type]').text(type === 'error' ? 'Error:' : 'Success:');
          $messages.find('[data-message]').text(message);

          return null;
        }

        function showError(message) {
          if (message instanceof Error) {
            message = message.message || 'Something went wrong...';
          }

          showMessage(message, 'error');
        }

        function showLocalError(message) {
          if (message instanceof Error) {
            message = message.message || 'Something went wrong...';
          }

          $root.find('[data-error]').text(message).removeClass('hidden');
        }

        function showSuccess(message) {
          showMessage(message, 'success');
        }

        // Get data from
        function getData($root, selector, dataField) {
          var data = {};

          $root.find(selector).each(function(index, item) {
            var $item = $(item);
            return data[$item.data(dataField)] = $item.val();
          });

          return data;
        }

      })();
    </script>
  </body>
</html>
